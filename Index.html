const { onValueCreated } = require("firebase-functions/v2/database");
const admin = require("firebase-admin");

admin.initializeApp();

// Esta funÃ§Ã£o vigia o banco e envia o push automaticamente
exports.notificarNovoPedido = onValueCreated("/pedidos/{pedidoId}", async (event) => {
    const pedido = event.data.val();
    const nomeCliente = pedido.cliente || "Novo Cliente";
    const valorTotal = pedido.total || 0;

    // 1. Busca os tokens dos administradores no banco
    const tokensSnapshot = await admin.database().ref("tokens_adm").once("value");
    const tokensData = tokensSnapshot.val();

    if (!tokensData) {
        console.log("Nenhum token de ADM encontrado.");
        return null;
    }

    const tokens = Object.values(tokensData).map(item => item.token);

    // 2. Monta a mensagem para o Google
    const message = {
        notification: {
            title: "ðŸ¥Ÿ NOVO PEDIDO CHEGOU!",
            body: `Cliente: ${nomeCliente}\nTotal: R$ ${valorTotal.toFixed(2)}`,
        },
        data: {
            url: "https://brunopeace.github.io/SALGADOS/paineladm.html"
        },
        tokens: tokens, 
    };

    // 3. Envia via Firebase Cloud Messaging
    try {
        const response = await admin.messaging().sendEachForMulticast(message);
        console.log("Sucesso:", response.successCount, "Falhas:", response.failureCount);
    } catch (error) {
        console.error("Erro ao enviar push:", error);
    }
});
